function crunchPlaylist(userId,playlistId,progress){spotifyGet("https://api.spotify.com/v1/users/"+userId+"/playlists/"+playlistId,function(data){var tracks=JSON.parse(data.responseText).tracks.items,user=users.get(userId);if(null===user.getPlaylist(playlistId)&&user.addPlaylist(playlistId,JSON.parse(data.responseText).name),user.getPlaylist(playlistId).active===!0)for(var i=0;i<tracks.length;i++)for(var trackId=tracks[i].track.id,trackArtists=tracks[i].track.artists,j=0;j<trackArtists.length;j++)if(null!=trackArtists[j].id&&null!=trackId){matches.add(trackArtists[j].id,trackId,userId);var artist=matches.getArtist(trackArtists[j].id);artist.name=trackArtists[j].name;var track=artist.getTrack(trackId);track.name=tracks[i].track.name,track.length=tracks[i].track.duration_ms}progress.complete()},function(data){progress.complete()})}function displayArtistInfo(artistId){var existing=document.getElementById("i-"+artistId);return null!==existing?void existing.remove():void spotifyGet("https://api.spotify.com/v1/artists/"+artistId,function(response){var artist=matches.getArtist(artistId),data=JSON.parse(response.responseText),row=document.createElement("tr");row.setAttribute("id","i-"+artistId);var col=document.createElement("td");col.setAttribute("class","a-cell"),col.setAttribute("colspan","3");var name=document.createElement("h2");if(name.appendChild(document.createTextNode(data.name)),data.images.length>0){for(var index,img=document.createElement("img"),i=0;i<data.images.length;i++)data.images[i].width>300&&(index=i);img.setAttribute("src",data.images[index].url)}var pUsers=document.createElement("p");pUsers.appendChild(document.createTextNode("Users: "));for(var i=0;i<artist.userIds.length;i++){var user=users.get(artist.userIds[i]),span=document.createElement("span");$(span).text(user.name),pUsers.appendChild(span);var sep;sep=i!=artist.userIds.length-1?document.createTextNode(", "):document.createTextNode("."),pUsers.appendChild(sep)}var table=document.createElement("table"),tbody=document.createElement("tbody"),headerRow=document.createElement("tr"),header1=document.createElement("td");$(header1).text("Track"),headerRow.appendChild(header1);var header2=document.createElement("td");$(header2).text("Users"),headerRow.appendChild(header2);var header3=document.createElement("td");$(header3).text("Length"),headerRow.appendChild(header3),tbody.appendChild(headerRow);for(var i=0;i<artist.tracks.length;i++){var trackTr=document.createElement("tr"),tdName=document.createElement("td");$(tdName).text(artist.tracks[i].name),trackTr.appendChild(tdName);for(var tdUsers=document.createElement("td"),j=0;j<artist.tracks[i].userIds.length;j++){for(var user=users.get(artist.tracks[i].userIds[j]),parts=user.name.split(" "),initials="",k=0;k<parts.length;k++)initials+=parts[k][0].toUpperCase();var span=document.createElement("span");$(span).text(initials),span.setAttribute("title",user.name),tdUsers.appendChild(span)}trackTr.appendChild(tdUsers);var mins=Math.floor(artist.tracks[i].length/6e4),secs=Math.floor((artist.tracks[i].length-1e3*mins*60)/1e3),tdLen=document.createElement("td");$(tdLen).text(mins+":"+(secs+1e15+"").slice(-2)),trackTr.appendChild(tdLen),tbody.appendChild(trackTr)}null!=img&&col.appendChild(img),col.appendChild(name),col.appendChild(pUsers),table.appendChild(tbody),col.appendChild(table),row.appendChild(col),$("#a-"+artistId).after(row)})}function displayArtists(array,offset,limit){if(null===offset||0===offset)for(var len=$("#artists tbody").children().length,i=0;len-1>i;i++)$("#artists tbody tr").last().remove();var start;start=null===offset?0:offset;var end;end=null===limit?array.length:Math.min(array.length,limit);for(var i=start;end>i;i++){var artist=array[i],row=document.createElement("tr");row.setAttribute("id","a-"+artist.artistId),row.setAttribute("onclick",'displayArtistInfo("'+artist.artistId+'")');var colName=document.createElement("td");colName.appendChild(document.createTextNode(artist.name)),row.appendChild(colName);var colTracks=document.createElement("td");colTracks.appendChild(document.createTextNode(artist.tracks.length)),row.appendChild(colTracks);var colUsers=document.createElement("td");colUsers.appendChild(document.createTextNode(artist.getUserCount())),row.appendChild(colUsers),$("#artists").append(row)}}function displayPlaylists(userId){var cell=$("#u-"+userId+" td")[0];if(1===cell.childNodes.length){var list=document.createElement("ul");list.setAttribute("class","playlists");for(var playlists=users.get(userId).playlists.sort(sorting.name).reverse(),i=0;i<playlists.length;i++){var listItem=document.createElement("li");listItem.setAttribute("id",userId+"-"+playlists[i].id),playlists[i].active===!0?listItem.style.color="rgb(180, 180, 180)":listItem.style.color="rgb(100, 100, 100)";var textSpan=document.createElement("span");textSpan.innerText=playlists[i].name,textSpan.setAttribute("onclick",'toggleActive("'+userId+'","'+playlists[i].id+'")'),listItem.appendChild(textSpan),list.appendChild(listItem)}cell.appendChild(list)}else cell.removeChild(cell.lastChild)}function getCurrentUser(progress){spotifyGet("https://api.spotify.com/v1/me",function(data){var userData=JSON.parse(data.responseText);users.add(userData.id,progress)})}function getPublicPlaylistIds(userId,progress){spotifyGet("https://api.spotify.com/v1/users/"+userId+"/playlists?limit=50",function(data){for(var playlists=JSON.parse(data.responseText).items,i=0;i<playlists.length;i++)progress.add(),crunchPlaylist(userId,playlists[i].id,progress)})}function recompute(){matches=new Matches,progress.queue=0,progress.completed=0;for(var i=0;i<users.users.length;i++)for(var j=0;j<users.users[i].playlists.length;j++)progress.add(),crunchPlaylist(users.users[i].id,users.users[i].playlists[j].id,progress)}function showMore(){var start=$("#artists tbody").children().length-1,end=start+limitDelta;displayArtists(matches.artists,start,end)}function spotifyGet(url,callback,error){$.ajax({url:url,beforeSend:function(xhr,settings){xhr.setRequestHeader("Authorization","Bearer "+localStorage.getItem("access_token"))},complete:function(data){200===data.status?callback(data):401===data.status?(console.log("Authorization error. Redirecting to login page."),window.location.replace("/")):error(data)}})}function toggleActive(userId,playlistId){var playlist=users.get(userId).getPlaylist(playlistId),element=$("#"+userId+"-"+playlistId)[0];playlist.active===!0?(playlist.active=!1,element.style.color="rgb(100, 100, 100)"):(playlist.active=!0,element.style.color="rgb(180, 180, 180)"),recompute()}function Artist(artistId){this.artistId=artistId,this.name,this.tracks=[],this.userIds=[]}function Matches(){this.artists=[]}function Playlist(playlistId,playlistName){this.id=playlistId,this.name=playlistName,this.active=!0}function Progress(update,finished){this.queue=0,this.completed=0,this.update=update,this.finished=finished}function Track(trackId){this.id=trackId,this.length,this.name,this.userIds=[]}function User(userId,userName){this.id=userId,this.name=userName,this.playlists=[]}function Users(){this.users=[]}var matches=new Matches,users=new Users,limitCurrent,limitDelta=20,progress=new Progress(function(){$("#progress").html("crunching playlists ("+progress.completed+" / "+progress.queue+")")},function(){matches.sort("users","desc",["tracks","desc","name","asc"],"users","desc",["name","asc"]),$("#progress").html("ready"),$("#show-more a").html("show more"),console.log(matches)}),sorting={length:function(a,b,order,ties){return"asc"===order?a.length-b.length:b.length-a.length},name:function(a,b,order,ties){var nameA=a.name.toLowerCase(),nameB=b.name.toLowerCase();return nameB>nameA?"asc"===order?-1:1:nameA>nameB?"asc"===order?1:-1:null!=ties&&"[object Array]"===Object.prototype.toString.call(ties)&&ties.length>1?sorting[ties[0]](a,b,ties[1],ties.slice(2)):0},tracks:function(a,b,order,ties){var tracksA=a.tracks.length,tracksB=b.tracks.length;return tracksA!=tracksB?"asc"===order?tracksA-tracksB:tracksB-tracksA:null!=ties&&"[object Array]"===Object.prototype.toString.call(ties)&&ties.length>1?sorting[ties[0]](a,b,ties[1],ties.slice(2)):0},users:function(a,b,order,ties){var countA=a.getUserCount(),countB=b.getUserCount();return countA!=countB?"asc"===order?countA-countB:countB-countA:null!=ties&&"[object Array]"===Object.prototype.toString.call(ties)&&ties.length>1?sorting[ties[0]](a,b,ties[1],ties.slice(2)):0}};$(document).ready(function(){console.log("Access token: "+localStorage.getItem("access_token")),console.log("Refresh token: "+localStorage.getItem("refresh_token")),getCurrentUser(progress)}),Artist.prototype.addTrack=function(trackId,userId){for(var index=-1,i=0;i<this.tracks.length;i++)this.tracks[i].id===trackId&&(index=i);if(-1===index){var track=new Track(trackId);track.addUser(userId),this.tracks.push(track)}else this.tracks[index].addUser(userId)},Artist.prototype.getTrack=function(trackId){for(var i=0;i<this.tracks.length;i++)if(this.tracks[i].id===trackId)return this.tracks[i];return 0},Artist.prototype.addUser=function(userId){-1===this.userIds.indexOf(userId)&&this.userIds.push(userId)},Artist.prototype.getUserCount=function(){return this.userIds.length},Artist.prototype.sort=function(sortBy,order,ties){var sorted=this.tracks,sortFunction=sorting[sortBy];return sorted=sorted.sort(function(a,b){return sortFunction(a,b,order,ties)})},Matches.prototype.add=function(artistId,trackId,userId){for(var index=-1,i=0;i<this.artists.length;i++)this.artists[i].artistId===artistId&&(index=i);if(-1===index){var artist=new Artist(artistId);artist.addUser(userId),artist.addTrack(trackId,userId),this.artists.push(artist)}else this.artists[index].addUser(userId),this.artists[index].addTrack(trackId,userId)},Matches.prototype.getArtist=function(artistId){for(var i=0;i<this.artists.length;i++)if(this.artists[i].artistId===artistId)return this.artists[i];return null},Matches.prototype.sort=function(sortBy,order,ties,trackSortBy,trackOrder,trackTies){var sorted=this.artists,sortFunction=sorting[sortBy];if(sorted=sorted.sort(function(a,b){return sortFunction(a,b,order,ties)}),null!=trackSortBy&&null!=trackOrder)for(var i=0;i<sorted.length;i++)sorted[i].sort(trackSortBy,trackOrder,trackTies);return limitCurrent=limitDelta,displayArtists(matches.artists,0,limitCurrent),sorted},Progress.prototype.add=function(){this.queue++},Progress.prototype.complete=function(){this.completed++,this.update(),this.queue===this.completed&&this.finished()},Track.prototype.addUser=function(userId){-1===this.userIds.indexOf(userId)&&this.userIds.push(userId)},Track.prototype.getUserCount=function(){return this.userIds.length},User.prototype.addPlaylist=function(playlistId,playlistName){this.playlists.push(new Playlist(playlistId,playlistName))},User.prototype.getPlaylist=function(playlistId){for(var i=0;i<this.playlists.length;i++)if(this.playlists[i].id===playlistId)return this.playlists[i];return null},Users.prototype.add=function(userId,progress){var array=this.users;-1!=userId.indexOf("user")&&(userId=userId.substring(userId.indexOf("user")+5));for(var i=0;i<array.length;i++)if(array[i].id===userId)return;spotifyGet("https://api.spotify.com/v1/users/"+userId,function(data){var name,userData=JSON.parse(data.responseText);name=null!=userData.display_name?userData.display_name:userId;var user=new User(userId,name);array.push(user);var userRow=document.createElement("tr");userRow.setAttribute("id","u-"+user.id);var userCol1=document.createElement("td"),userNameElement=document.createElement("span");userNameElement.setAttribute("onclick",'displayPlaylists("'+user.id+'")'),userNameElement.appendChild(document.createTextNode(user.name)),userCol1.appendChild(userNameElement),userRow.appendChild(userCol1),$("#users").append(userRow)}),getPublicPlaylistIds(userId,progress)},Users.prototype.get=function(userId){for(var index=-1,i=0;i<this.users.length;i++)this.users[i].id===userId&&(index=i);return-1!=index?this.users[index]:null};